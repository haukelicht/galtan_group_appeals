# +~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~ #  
#
#' @title  Parse worker responses for annotation 
#'          job "grp-group-mention-anno-b1"
#' @author Hauke Licht
#' @date   2024-07-01
#
# +~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~+~ #

# setup ----

library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(jsonlite)

source(file.path("code", "utils.R"))

# parse worker response files into data frame ----

JOB_NAME = "group-mention-annotation-batch-01"

data_path <- file.path("data", "annotations", JOB_NAME)

# label map
label_map <- map_chr(read_json(file.path("data", "annotations", "label_config.json")), "text")
label_map <- setNames(seq_along(label_map), label_map)

# parse coder annotations and gold annotations ----

responses <- parse_workers_responses(
  files = c(
    file.path(data_path, "annotations", "emarie.jsonl")
  ),
  worker.ids = c("annotator"),
  label.map = label_map
)

responses


# get to-be-discussed instances ----

tbd <- tribble(
  ~id,
  "11110_198809-390636",
  "11320_199109-391124",
  "11620_199109-391318",
  "12110_201709-345720",
  "12110_201709-346919",
  "13229_199409-186639",
  "13230_198112-182540",
  "13230_198112-182574",
  "13230_201109-193165",
  "13720_200111-189425",
  "14820_197003-197239",
  "14820_197201-197431",
  "14820_201904-206108",
  "171101_200306-303336",
  "171101_201807-310895",
  "21111_198111-23438",
  "21914_199906-49702",
  "21914_200706-69175",
  "22110_200301-320089",
  "22110_200611-322337",
  "22720_200205-319650",
  "22720_200205-319486",
  "22720_200301-321138",
  "31110_199303-208361",
  "31720_200706-213746",
  "31720_201706-218594",
  "32110_198706-281408",
  "32630_201302-287967",
  "32720_199403-282961",
  "32720_199604-283847",
  "32720_200804-287565",
  "35110_201510-372771",
  "43110_198710-98339",
  "53110_200205-277084",
  "61620_199611-419672",
  "63110_201905-03407",
  "64110_200509-352476",
  "82710_200206-113129",
  "87071_201810-301884",
  "93712_199209-377225",
  "97110_199004-382464"
)


tbd |> 
  left_join(responses) |> 
  select(id, text, label) |> 
  unnest_longer(label) |> 
  unnest_wider(label, names_sep = "_") |> 
  mutate(
    mention = substr(text, label_1+1, label_2),
    label = label_3 
  ) |> 
  select(-starts_with("label_")) |> 
  filter(label == "unsure") |> 
  View()

# create separate job to review unsure instances ----

review_cases <- tribble(
  ~id,
  "11320_200609-394180",
  "11710_201809-401224",
  "13230_198112-182474",
  "21914_200305-55969",
  "22110_199805-315922",
  "22110_200301-320320",
  "22722_200611-322718",
  "22722_201006-324538",
  "32110_199604-283544",
  "32630_201803-288330",
  "32630_201803-288300",
  "34730_201501-254923",
  "34730_201501-254925",
  "35110_201106-372680",
  "35110_201510-372900",
  "41111_198701-123787",
  "41112_199012-127175",
  "41112_199012-127403",
  "41320_197610-119841",
  "41320_198303-122571",
  "41320_200509-143173",
  "41320_202109-176197",
  "41521_197211-119016",
  "42120_201710-19257",
  "42420_200211-11355",
  "43810_200710-102844",
  "43810_201510-106399",
  "43810_201910-108260",
  "51320_200505-233952",
  "51320_201706-243948",
  "51620_198706-225253",
  "55110_201605-111881",
  "55110_201605-112400",
  "61320_197211-401791",
  "62110_200810-96869",
  "63110_201607-02746",
  "64110_200811-352558",
  "64110_201709-356777",
  "80620_200907-92823",
  "81111_199004-254942",
  "81952_200711-255088",
  "81952_201112-255486",
  "82710_199206-112660",
  "82710_199806-112871",
  "86110_201404-269122",
  "86110_201804-273634",
  "86421_201404-269781",
  "86421_201404-269862",
  "87071_201810-301884",
  "92436_200710-361491",
  "92436_201510-366235",
  "92436_201510-366686",
  "92712_199110-359800",
  "93111_199005-376933",
  "93111_199005-376929",
  "93111_199005-376928",
  "93711_199611-377366",
  "93712_199209-377225",
  "93712_199209-377150",
  "93712_199611-377436",
  "93712_200411-377516",
  "21914_198111-24270",
  "11110_198809-390636",
  "11320_199109-391124",
  "11620_199109-391318",
  "12110_201709-345720",
  "12110_201709-346919",
  "13229_199409-186639",
  "13230_198112-182540",
  "13230_198112-182574",
  "13230_201109-193165",
  "13720_200111-189425",
  "14820_197003-197239",
  "14820_197201-197431",
  "14820_201904-206108",
  "171101_200306-303336",
  "171101_201807-310895",
  "21111_198111-23438",
  "21914_199906-49702",
  "21914_200706-69175",
  "22110_200301-320089",
  "22110_200611-322337",
  "22720_200205-319650",
  "22720_200205-319486",
  "22720_200301-321138",
  "31110_199303-208361",
  "31720_200706-213746",
  "31720_201706-218594",
  "32110_198706-281408",
  "32630_201302-287967",
  "32720_199403-282961",
  "32720_199604-283847",
  "32720_200804-287565",
  "35110_201510-372771",
  "43110_198710-98339",
  "53110_200205-277084",
  "61620_199611-419672",
  "63110_201905-03407",
  "64110_200509-352476",
  "82710_200206-113129",
  "87071_201810-301884",
  "93712_199209-377225",
  "97110_199004-382464",
)


jsonify <- function(x) {
  x <- as.list(x)
  x$label <- x$label[[1]]
  x$metadata <- x$metadata[[1]]
  jsonlite::toJSON(x, auto_unbox = TRUE)
}

lines <- review_cases |> 
  left_join(responses) |> 
  select(id, text, label, metadata) |> 
  rowwise() |> 
  group_split() |>
  map_chr(jsonify)


fp <- file.path(data_path, "review_cases.json")
write_lines(lines, fp)

# after manual review

reviewed <- parse_worker_responses(fp = file.path(data_path, "reviewed.jsonl"), worker.id = 'expert', label.map = label_map)

lines <- bind_rows(
  filter(responses, !id %in% review_cases$id),
  responses |> 
    subset(id %in% review_cases$id, c(id, text_nr)) |> 
    inner_join(select(reviewed, -text_nr), by = "id")
) |> 
  arrange(text_nr) |> 
  select(id, text, label, metadata) |> 
  rowwise() |> 
  group_split() |>
  map_chr(jsonify)


fp <- file.path(data_path, "review_annotations.json")
write_lines(lines, fp)


